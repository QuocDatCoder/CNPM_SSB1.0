# ğŸ”„ Data Flow Diagram - Dual Direction Architecture

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SMART BUS TRACKING SYSTEM                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend (FE)  â”‚                              â”‚  Backend (BE)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Parent Dashboard â”‚â—„â”€â”€â”€â”€â”€â”€â”€ API Requests â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Schedule Service â”‚
â”‚ (Dashboard.jsx)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€ API Response â”€â”€â”€â”€â”€â”€â–ºâ”‚ Student Service  â”‚
â”‚                  â”‚                              â”‚                  â”‚
â”‚ Displays:        â”‚                              â”‚ Database:        â”‚
â”‚ - 2 trip cards   â”‚                              â”‚ - Students table â”‚
â”‚ - Morning trip   â”‚                              â”‚ - Routes table   â”‚
â”‚ - Afternoon trip â”‚                              â”‚ - Schedules tableâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Model Evolution

### BEFORE (Single Direction)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Students Table         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                          â”‚
â”‚ ho_ten                      â”‚
â”‚ lop                         â”‚
â”‚ default_route_stop_id â—„â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Only ONE route!
â”‚ parent_id                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (1 route only)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Routes & RouteStops      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Route 1 or Route 2          â”‚
â”‚ (Either morning OR evening) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AFTER (Dual Direction)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Students Table (NEW)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                                       â”‚
â”‚ ho_ten                                   â”‚
â”‚ lop                                      â”‚
â”‚ default_route_stop_id_di â—„â”€â”  â”Œâ”€â–º Route 1 (Morning)
â”‚ default_route_stop_id_ve â—„â”€â”¤  â””â”€â–º Route 2 (Afternoon)
â”‚ parent_id                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ Morning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â–¼
         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚ Route 1 (DI)     â”‚
         â”‚              â”‚ LÆ°á»£t Ä‘i (6:00am) â”‚
         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€ Afternoon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Route 2 (VE)     â”‚
                        â”‚ LÆ°á»£t vá» (3:30pm) â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ API Request Flow

### Create Student with Dual Routes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Frontend Form (FE sends dual route data)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/students/with-parent                                  â”‚
â”‚ {                                                               â”‚
â”‚   ho_ten_hs: "Nguyá»…n VÄƒn TÃ¨o"                                   â”‚
â”‚   route_id_di: 1,    â—„â”€â”€â”€ Morning route                         â”‚
â”‚   stop_id_di: 5,     â—„â”€â”€â”€ Morning stop                          â”‚
â”‚   route_id_ve: 2,    â—„â”€â”€â”€ Afternoon route                       â”‚
â”‚   stop_id_ve: 6      â—„â”€â”€â”€ Afternoon stop                        â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Backend createStudentWithParent() function                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Create/find Parent user                                      â”‚
â”‚ 2. Get RouteStop for di (route 1, stop 5)                       â”‚
â”‚ 3. Get RouteStop for ve (route 2, stop 6)                       â”‚
â”‚ 4. Create Student with BOTH RouteStop IDs                       â”‚
â”‚    - default_route_stop_id_di = 1                               â”‚
â”‚    - default_route_stop_id_ve = 14                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Auto-Assign Function Called                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ autoAssignToSchedule(studentId, routeStopIdDi, routeStopIdVe)   â”‚
â”‚ 1. Fetch RouteStop records for both IDs                         â”‚
â”‚ 2. Group by route_id â†’ Identify Route 1 & Route 2              â”‚
â”‚ 3. Find schedules for Route 1 (today)                           â”‚
â”‚ 4. Find schedules for Route 2 (today)                           â”‚
â”‚ 5. Create ScheduleStudent records:                              â”‚
â”‚    - Schedule 1 (Route 1) + Student 36 + Stop 5                 â”‚
â”‚    - Schedule 2 (Route 2) + Student 36 + Stop 6                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Database Result (2 ScheduleStudent records created)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ScheduleStudents:                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚ â”‚ id=101 â”‚ schedule_id=1  â”‚ student_id=36â”‚ â—„â”€ Morning          â”‚
â”‚ â”‚ id=102 â”‚ schedule_id=2  â”‚ student_id=36â”‚ â—„â”€ Afternoon        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Parent Dashboard Query                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GET /api/schedules/parent/my-kids-trip?userId=7               â”‚
â”‚ Returns: [{danh_sach_chuyen: [morning_trip, afternoon_trip]}] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Frontend Displays 2 Trip Cards                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Buá»•i SÃ¡ng (Morning)  â”‚      â”‚ Buá»•i Chiá»u (Aft.)   â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ Tuyáº¿n 1              â”‚      â”‚ Tuyáº¿n 1              â”‚        â”‚
â”‚  â”‚ 6:00 AM              â”‚      â”‚ 3:30 PM              â”‚        â”‚
â”‚  â”‚ Crescent Mall        â”‚      â”‚ Crescent Mall        â”‚        â”‚
â”‚  â”‚ TÃ i xáº¿: TÃ¨o          â”‚      â”‚ TÃ i xáº¿: TÃ¨o          â”‚        â”‚
â”‚  â”‚ 51B-001.01           â”‚      â”‚ 51B-001.01           â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ Table Relationships

### Before (Single Column)

```
      Students
         â”‚
         â”‚ default_route_stop_id
         â”‚
         â–¼
     RouteStops
         â”‚
         â”œâ”€ route_id
         â””â”€ stop_id
```

### After (Dual Columns)

```
      Students
         â”‚
         â”œâ”€ default_route_stop_id_di (Morning)
         â”‚  â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â–¼
         â”‚                 RouteStops
         â”‚                    â”‚
         â”‚                    â”œâ”€ Route 1 (DI)
         â”‚                    â””â”€ Stop 5 (Morning pickup)
         â”‚
         â””â”€ default_route_stop_id_ve (Afternoon)
            â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â–¼
                           RouteStops
                              â”‚
                              â”œâ”€ Route 2 (VE)
                              â””â”€ Stop 6 (Afternoon dropoff)
```

---

## ğŸ”„ Auto-Assign Algorithm

```
CREATE SCHEDULE (Route 1, LÆ°á»£t Äi)
        â”‚
        â–¼
Get loai_tuyen = "luot_di"
        â”‚
        â–¼
Get RouteStops for Route 1
        â”‚
        â–¼
Find ALL Students WHERE
  default_route_stop_id_di IN (RouteStop IDs)
        â”‚
        â–¼
For each Student:
  â”‚
  â”œâ”€ Find the exact RouteStop they use on Route 1
  â”‚
  â”œâ”€ Create ScheduleStudent with:
  â”‚  - schedule_id = new schedule ID
  â”‚  - student_id = this student
  â”‚  - stop_id = their assigned stop
  â”‚
        â”‚
        â–¼
Result: All morning students auto-assigned âœ…

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CREATE SCHEDULE (Route 2, LÆ°á»£t Vá»)
        â”‚
        â–¼
Get loai_tuyen = "luot_ve"
        â”‚
        â–¼
Get RouteStops for Route 2
        â”‚
        â–¼
Find ALL Students WHERE
  default_route_stop_id_ve IN (RouteStop IDs)
        â”‚
        â–¼
For each Student:
  â”‚
  â”œâ”€ Find the exact RouteStop they use on Route 2
  â”‚
  â”œâ”€ Create ScheduleStudent with:
  â”‚  - schedule_id = new schedule ID
  â”‚  - student_id = this student
  â”‚  - stop_id = their assigned stop
  â”‚
        â”‚
        â–¼
Result: All afternoon students auto-assigned âœ…
```

---

## ğŸ“Š Data Counts (After Migration)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           SEED DATA STRUCTURE                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚ Users:                  46                   â”‚
â”‚  â”œâ”€ Admin:              1                    â”‚
â”‚  â”œâ”€ Drivers:            5  (1001-1005)       â”‚
â”‚  â””â”€ Parents:            40 (2001-2040)       â”‚
â”‚                                              â”‚
â”‚ Routes:                 10  (5 Ã— 2 directions)
â”‚  â”œâ”€ Route 1 (Tuyáº¿n 1 DI): 6:00am            â”‚
â”‚  â”œâ”€ Route 2 (Tuyáº¿n 1 VE): 3:30pm            â”‚
â”‚  â”œâ”€ Route 3-4 (Tuyáº¿n 2): 6:15am/3:45pm     â”‚
â”‚  â”œâ”€ Route 5-6 (Tuyáº¿n 3): 5:45am/3:30pm     â”‚
â”‚  â”œâ”€ Route 7-8 (Tuyáº¿n 4): 6:00am/3:30pm     â”‚
â”‚  â””â”€ Route 9-10 (Tuyáº¿n 5): 6:00am/3:40pm    â”‚
â”‚                                              â”‚
â”‚ RouteStops:             40 (4 per route)    â”‚
â”‚  â””â”€ Each route: 3-4 pickup + 1 school       â”‚
â”‚                                              â”‚
â”‚ Stops:                  16                   â”‚
â”‚  â”œâ”€ School:             1                    â”‚
â”‚  â””â”€ Pickup/Dropoff:     15                   â”‚
â”‚                                              â”‚
â”‚ Students:               35 (7 per tuyáº¿n)    â”‚
â”‚  â””â”€ Each with 2 assignments (DI + VE)       â”‚
â”‚                                              â”‚
â”‚ Schedules:              10 (for CURDATE())   â”‚
â”‚  â”œâ”€ Morning (DI):       5                    â”‚
â”‚  â””â”€ Afternoon (VE):     5                    â”‚
â”‚                                              â”‚
â”‚ ScheduleStudents:       70  âœ…              â”‚
â”‚  â””â”€ 35 students Ã— 2 schedules each          â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”€ State Transitions

### Student Creation Flow

```
Empty Form
    â†“
Enter Basic Info (Name, Class, etc.)
    â†“
Select Parent (or create new)
    â†“
Select Morning Route & Stop
    â†“
Select Afternoon Route & Stop
    â†“
Submit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚
         â”‚ API POST Request       â”‚
         â”‚                        â”‚
         â–¼                        â”‚
    Backend                       â”‚
         â”‚                        â”‚
         â”œâ”€ Create Parent â—„â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Create Student â—„â”€â”€â”€â”€â”€â”€â”¤
         â”‚  Create ScheduleStudents (auto)
         â”‚
         â””â”€ Response Success â”€â”€â”€â”€â”
                                 â–¼
                            Parent Dashboard
                            Shows 2 trips âœ…
```

---

## ğŸ“ˆ Query Flow: Parent Views Dashboard

```
Parent Dashboard
   â”‚
   â”œâ”€ Parent login (userId=7)
   â”‚
   â””â”€ Fetch data
        â”‚
        â–¼
   GET /api/schedules/parent/my-kids-trip
        â”‚
        â–¼
   Backend Logic:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ 1. Find Students where parent_id=7 â”‚
   â”‚    Result: [Student 1, 7, 8, ...]  â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 2. Find ScheduleStudents for each  â”‚
   â”‚    Result: [SS#1, SS#2, ...]       â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 3. Join with Schedules & Routes    â”‚
   â”‚    Morning: Route 1, 6:00am        â”‚
   â”‚    Afternoon: Route 2, 3:30pm      â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 4. Filter by today's date          â”‚
   â”‚ 5. Format for FE response          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   Response:
   {
     danh_sach_chuyen: [
       {schedule: 1, loai_chuyen: "LÆ°á»£t Ä‘i", gio: "06:00"},
       {schedule: 2, loai_chuyen: "LÆ°á»£t vá»", gio: "15:30"}
     ]
   }
        â”‚
        â–¼
   Frontend:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ flatMap trips array     â”‚
   â”‚ Creates 2 trip cards    â”‚
   â”‚ Morning & Afternoon âœ…  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Improvements

```
BEFORE                          AFTER
â”€â”€â”€â”€â”€â”€                          â”€â”€â”€â”€â”€

Student route: 1 per day   â†’   Student routes: 2 per day
               (Morning           (Morning pickup +
                OR                 Afternoon dropoff)
                Afternoon)

ScheduleStudents: ~35      â†’   ScheduleStudents: 70
                                 (Complete coverage)

Parent sees: 1 trip/day    â†’   Parent sees: 2 trips/day
             (Unclear              (Morning +
              direction)            Afternoon clear)

Auto-assign: Single route  â†’   Auto-assign: Smart
             only                 (Filters by loai_tuyen)

Frontend: N/A              â†’   Frontend: Works unchanged!
          (No dual data)          (Automatic dual support)
```

---

## âœ… Verification Points

```
CREATE â†’ ASSIGN â†’ QUERY â†’ DISPLAY
   â”‚        â”‚       â”‚         â”‚
   â–¼        â–¼       â–¼         â–¼

Student Created?
â”œâ”€ default_route_stop_id_di? âœ…
â””â”€ default_route_stop_id_ve? âœ…
                â–¼
Auto-Assign Created?
â”œâ”€ ScheduleStudent for DI? âœ…
â”œâ”€ ScheduleStudent for VE? âœ…
â””â”€ Correct stop_ids? âœ…
                â–¼
Query Returns Data?
â”œâ”€ Morning trip? âœ…
â”œâ”€ Afternoon trip? âœ…
â””â”€ Both with correct info? âœ…
                â–¼
Frontend Display Correct?
â”œâ”€ 2 trip cards? âœ…
â”œâ”€ Morning labeled correctly? âœ…
â”œâ”€ Afternoon labeled correctly? âœ…
â””â”€ All data displayed? âœ…
```

---

This architecture ensures:

- âœ… Students have clear morning & afternoon assignments
- âœ… Complete ScheduleStudent coverage
- âœ… Smart auto-assignment based on route type
- âœ… Parent sees full trip information
- âœ… Frontend works without modifications

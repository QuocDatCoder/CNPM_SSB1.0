<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Assignment History API</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 20px 0;
      }
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      label {
        font-weight: bold;
        color: #555;
      }
      input,
      select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 12px 24px;
        margin: 10px 5px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      button:hover {
        background: #45a049;
      }
      button.secondary {
        background: #2196f3;
      }
      button.secondary:hover {
        background: #0b7dda;
      }
      .result {
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        max-height: 500px;
        overflow-y: auto;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      .error {
        color: #f44336;
        font-weight: bold;
      }
      pre {
        background: #282c34;
        color: #abb2bf;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }
      th,
      td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #4caf50;
        color: white;
      }
      tr:hover {
        background: #f5f5f5;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .stat-card h3 {
        margin: 0;
        font-size: 32px;
      }
      .stat-card p {
        margin: 5px 0 0 0;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìä Test Assignment History API</h1>
      <p>
        Backend URL:
        <strong>http://localhost:8080/api/schedules/history/logs</strong>
      </p>

      <div class="controls">
        <div class="control-group">
          <label for="dateFilter">Ng√†y:</label>
          <input type="date" id="dateFilter" />
        </div>
        <div class="control-group">
          <label for="typeFilter">Lo·∫°i chuy·∫øn:</label>
          <select id="typeFilter">
            <option value="">T·∫•t c·∫£</option>
            <option value="luot_di">L∆∞·ª£t ƒëi</option>
            <option value="luot_ve">L∆∞·ª£t v·ªÅ</option>
          </select>
        </div>
      </div>

      <div>
        <button onclick="testAllRecords()">L·∫•y t·∫•t c·∫£ l·ªãch s·ª≠</button>
        <button onclick="testWithFilters()" class="secondary">
          L·ªçc theo ƒëi·ªÅu ki·ªán
        </button>
        <button onclick="testToday()" class="secondary">L·ªãch s·ª≠ h√¥m nay</button>
        <button onclick="testCreateDelete()">Test T·∫°o + X√≥a Schedule</button>
      </div>

      <div id="stats" class="stats" style="display: none"></div>

      <div id="result" class="result">
        <p>Ch·ªçn m·ªôt test ƒë·ªÉ b·∫Øt ƒë·∫ßu...</p>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:8080/api";
      const resultDiv = document.getElementById("result");
      const statsDiv = document.getElementById("stats");

      // Set today's date as default
      document.getElementById("dateFilter").valueAsDate = new Date();

      function displayStats(data) {
        const total = data.length;
        const luotDi = data.filter((d) => d.loai_tuyen === "luot_di").length;
        const luotVe = data.filter((d) => d.loai_tuyen === "luot_ve").length;

        statsDiv.style.display = "grid";
        statsDiv.innerHTML = `
          <div class="stat-card">
            <h3>${total}</h3>
            <p>T·ªïng s·ªë b·∫£n ghi</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h3>${luotDi}</h3>
            <p>L∆∞·ª£t ƒëi</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <h3>${luotVe}</h3>
            <p>L∆∞·ª£t v·ªÅ</p>
          </div>
        `;
      }

      function displayTable(data) {
        if (data.length === 0) {
          return "<p class='error'>Kh√¥ng c√≥ d·ªØ li·ªáu</p>";
        }

        let html = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Tuy·∫øn</th>
                <th>Lo·∫°i</th>
                <th>Thao t√°c</th>
                <th>Th·ªùi gian</th>
              </tr>
            </thead>
            <tbody>
        `;

        data.forEach((item) => {
          const date = new Date(item.ngay);
          const formattedDate = date.toLocaleString("vi-VN");
          const loaiText =
            item.loai_tuyen === "luot_di" ? "üü¢ L∆∞·ª£t ƒëi" : "üîµ L∆∞·ª£t v·ªÅ";

          html += `
            <tr>
              <td>${item.id}</td>
              <td><strong>${item.ten_tuyen}</strong></td>
              <td>${loaiText}</td>
              <td>${item.noidung}</td>
              <td>${formattedDate}</td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        return html;
      }

      async function testAllRecords() {
        try {
          resultDiv.innerHTML = "<p>üîÑ ƒêang t·∫£i...</p>";
          const response = await fetch(
            `${API_BASE_URL}/schedules/history/logs`
          );
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          const data = result.data || result;

          displayStats(data);

          resultDiv.innerHTML = `
            <h3 class="success">‚úÖ Th√†nh c√¥ng - T·∫•t c·∫£ l·ªãch s·ª≠</h3>
            <p>S·ªë b·∫£n ghi: <strong>${data.length}</strong></p>
            ${displayTable(data)}
            <details style="margin-top: 20px;">
              <summary style="cursor: pointer; font-weight: bold;">Xem JSON Raw</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } catch (error) {
          statsDiv.style.display = "none";
          resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
        }
      }

      async function testWithFilters() {
        try {
          const date = document.getElementById("dateFilter").value;
          const type = document.getElementById("typeFilter").value;

          let url = `${API_BASE_URL}/schedules/history/logs`;
          const params = new URLSearchParams();
          if (date) params.append("date", date);
          if (type) params.append("type", type);

          if (params.toString()) {
            url += `?${params.toString()}`;
          }

          resultDiv.innerHTML = "<p>üîÑ ƒêang t·∫£i...</p>";
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          const data = result.data || result;

          displayStats(data);

          resultDiv.innerHTML = `
            <h3 class="success">‚úÖ Th√†nh c√¥ng - L·ªçc theo ƒëi·ªÅu ki·ªán</h3>
            <p>URL: <code>${url}</code></p>
            <p>Ng√†y: <strong>${date || "T·∫•t c·∫£"}</strong> | Lo·∫°i: <strong>${
            type || "T·∫•t c·∫£"
          }</strong></p>
            <p>S·ªë b·∫£n ghi: <strong>${data.length}</strong></p>
            ${displayTable(data)}
            <details style="margin-top: 20px;">
              <summary style="cursor: pointer; font-weight: bold;">Xem JSON Raw</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } catch (error) {
          statsDiv.style.display = "none";
          resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
        }
      }

      async function testToday() {
        try {
          const today = new Date().toISOString().split("T")[0];
          resultDiv.innerHTML = "<p>üîÑ ƒêang t·∫£i l·ªãch s·ª≠ h√¥m nay...</p>";

          const response = await fetch(
            `${API_BASE_URL}/schedules/history/logs?date=${today}`
          );
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const result = await response.json();
          const data = result.data || result;

          displayStats(data);

          resultDiv.innerHTML = `
            <h3 class="success">‚úÖ L·ªãch s·ª≠ h√¥m nay (${today})</h3>
            <p>S·ªë b·∫£n ghi: <strong>${data.length}</strong></p>
            ${displayTable(data)}
            <details style="margin-top: 20px;">
              <summary style="cursor: pointer; font-weight: bold;">Xem JSON Raw</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } catch (error) {
          statsDiv.style.display = "none";
          resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
        }
      }

      async function testCreateDelete() {
        try {
          resultDiv.innerHTML = "<p>üîÑ ƒêang test t·∫°o v√† x√≥a schedule...</p>";

          // 1. T·∫°o schedule m·ªõi
          const createPayload = {
            route_id: 1,
            driver_id: 1,
            bus_id: 1,
            ngay_chay: new Date().toISOString().split("T")[0],
            gio_bat_dau: "06:00:00",
          };

          const createResponse = await fetch(`${API_BASE_URL}/schedules`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(createPayload),
          });

          if (!createResponse.ok) {
            throw new Error(`T·∫°o schedule th·∫•t b·∫°i: ${createResponse.status}`);
          }

          const createResult = await createResponse.json();
          const scheduleId = createResult.data
            ? createResult.data.id
            : createResult.id;

          // Wait 1 second
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // 2. L·∫•y l·ªãch s·ª≠
          const historyResponse = await fetch(
            `${API_BASE_URL}/schedules/history/logs`
          );
          const historyResult = await historyResponse.json();
          const historyData = historyResult.data || historyResult;

          // 3. X√≥a schedule
          const deleteResponse = await fetch(
            `${API_BASE_URL}/schedules/${scheduleId}`,
            {
              method: "DELETE",
            }
          );

          if (!deleteResponse.ok && deleteResponse.status !== 204) {
            throw new Error(`X√≥a schedule th·∫•t b·∫°i: ${deleteResponse.status}`);
          }

          // Wait 1 second
          await new Promise((resolve) => setTimeout(resolve, 1000));

          // 4. L·∫•y l·ªãch s·ª≠ l·∫ßn n·ªØa
          const historyResponse2 = await fetch(
            `${API_BASE_URL}/schedules/history/logs`
          );
          const historyResult2 = await historyResponse2.json();
          const historyData2 = historyResult2.data || historyResult2;

          displayStats(historyData2);

          resultDiv.innerHTML = `
            <h3 class="success">‚úÖ Test T·∫°o + X√≥a th√†nh c√¥ng!</h3>
            <p><strong>B∆∞·ªõc 1:</strong> T·∫°o schedule ID: ${scheduleId}</p>
            <p><strong>B∆∞·ªõc 2:</strong> L·ªãch s·ª≠ sau khi t·∫°o: ${
              historyData.length
            } b·∫£n ghi</p>
            <p><strong>B∆∞·ªõc 3:</strong> X√≥a schedule ID: ${scheduleId}</p>
            <p><strong>B∆∞·ªõc 4:</strong> L·ªãch s·ª≠ sau khi x√≥a: ${
              historyData2.length
            } b·∫£n ghi</p>
            <p class="success">‚úÖ C·∫£ 2 thao t√°c ƒë·ªÅu ƒë∆∞·ª£c ghi log!</p>
            ${displayTable(historyData2.slice(0, 10))}
            <details style="margin-top: 20px;">
              <summary style="cursor: pointer; font-weight: bold;">Xem 10 b·∫£n ghi m·ªõi nh·∫•t</summary>
              <pre>${JSON.stringify(historyData2.slice(0, 10), null, 2)}</pre>
            </details>
          `;
        } catch (error) {
          statsDiv.style.display = "none";
          resultDiv.innerHTML = `<p class="error">‚ùå L·ªói: ${error.message}</p>`;
        }
      }
    </script>
  </body>
</html>
